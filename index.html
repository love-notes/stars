<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ========================================================= -->
  <!-- ====================== META / BASE ====================== -->
  <!-- ========================================================= -->
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <meta name="theme-color" content="#eaf6ff" />
  <title>arcade love story</title>

  <!-- ========================================================= -->
  <!-- ========================= FONT ========================== -->
  <!-- ========================================================= -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap"
    rel="stylesheet"
  />

  <style>
    /* ========================================================= */
    /* ========================= RESET ========================= */
    /* ========================================================= */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(circle at 18% 12%, rgba(255,255,255,0.90) 0%, rgba(234,246,255,0.75) 36%, rgba(255,234,242,0.72) 82%),
        linear-gradient(180deg, #eef7ff 0%, #ffeef6 100%);
    }

    body{
  display:flex;
  align-items:center;
  justify-content:center;

  /* replace padding 14px */
  padding: calc(14px + var(--safe-top)) 14px calc(14px + var(--safe-bottom));
}

    button {
      font: inherit;
      color: inherit;
      border: none;
      background: none;
      appearance: none;
      -webkit-appearance: none;
    }

    img {
      display: block;
      max-width: 100%;
    }

    /* ========================================================= */
    /* ========================= THEME ========================= */
    /* ========================================================= */
    :root {
      /* Pastel base */
      --baby-blue-0: #f3fbff;
      --baby-blue-1: #eaf6ff;
      --baby-blue-2: #dff1ff;
      --baby-blue-3: rgba(190, 225, 255, 0.92);

      --baby-pink-0: #fff7fb;
      --baby-pink-1: #ffeaf2;
      --baby-pink-2: #ffdbe9;
      --baby-pink-3: rgba(255, 205, 226, 0.92);

      /* Outline stroke (brown + white option kept) */
      --stroke: rgba(143, 93, 66, 0.78);
--stroke-soft: rgba(143, 93, 66, 0.22);
--stroke-softer: rgba(143, 93, 66, 0.14);
      --stroke-white: rgba(255, 255, 255, 0.86);

      /* Ink */
      --ink: #8f5d42;
      --ink-soft: rgba(143, 93, 66, 0.72);

      /* Panel */
      --paper: rgba(255,255,255,0.96);
      --paper-soft: rgba(255,255,255,0.88);

      /* Glass */
      --glass: rgba(255,255,255,0.56);
      --glass-border: rgba(255,255,255,0.76);

      /* Glow */
      --glow-pink: rgba(255, 190, 215, 0.62);
      --glow-blue: rgba(180, 220, 255, 0.54);

      /* Shadow */
      --shadow-1: 0 10px 24px rgba(0, 0, 0, 0.10);
      --shadow-2: 0 20px 46px rgba(0, 0, 0, 0.14);

      /* Sizing */
      --cab-w: 360px;
      --cab-h: 740px;

      --stroke-w: 3px;
--stroke-w2: 2px;
      --stroke-w3: 2px;

      --radius-cab: 44px;
      --radius-cap: 28px;
      --radius-panel: 30px;
      --radius-screen: 18px;

      /* Screen height tuned so claim never clips */
      --screen-h: 404px;
      --deck-gap: 18px;

      /* Safe areas */
      --safe-top: max(env(safe-area-inset-top, 0px), constant(safe-area-inset-top, 0px));
      --safe-bottom: max(env(safe-area-inset-bottom, 0px), constant(safe-area-inset-bottom, 0px));
    }

    /* ========================================================= */
    /* ========================= STAGE ========================= */
    /* ========================================================= */
    .stage {
      width: min(var(--cab-w), 96vw);
      height: min(var(--cab-h), 96vh);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* ========================================================= */
    /* ======================== CABINET ======================== */
    /* ========================================================= */
    .cabinet {
      width: 100%;
      height: 100%;
      background:
        linear-gradient(
          180deg,
          var(--baby-blue-1) 0%,
          var(--baby-blue-2) 34%,
          var(--baby-pink-1) 76%,
          var(--baby-pink-2) 100%
        );
      border-radius: var(--radius-cab);
      border: var(--stroke-w) solid var(--stroke);
      box-shadow: var(--shadow-2);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    /* Inner outline like reference */
    .cabinet::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: calc(var(--radius-cab) - 8px);
      border: var(--stroke-w2) solid var(--stroke-soft);
      pointer-events: none;
    }

    /* ========================================================= */
    /* ========================= MARQUEE ======================= */
    /* ========================================================= */
    .top-cap {
      width: 92%;
      height: 74px;
      margin-top: 18px;
      border-radius: var(--radius-cap);
      border: var(--stroke-w) solid var(--stroke);
      background:
        linear-gradient(180deg, rgba(255,255,255,0.92) 0%, rgba(255,240,246,0.96) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .top-cap::before {
      content: "";
      position: absolute;
      inset: 8px;
      border-radius: 22px;
      border: var(--stroke-w2) solid var(--stroke-soft);
      pointer-events: none;
    }

    .marquee-text {
      font-size: 14px;
      letter-spacing: 3px;
      color: var(--ink);
      user-select: none;
      text-transform: lowercase;
      opacity: 0.92;
    }

    .marquee-dots {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.55;
    }

    .marquee-dots::before,
    .marquee-dots::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 52px;
      height: 10px;
      transform: translateY(-50%);
      border-radius: 999px;
      background:
        radial-gradient(circle at 8% 50%, rgba(143,93,66,0.32) 0 3px, transparent 4px),
        radial-gradient(circle at 24% 50%, rgba(143,93,66,0.32) 0 3px, transparent 4px),
        radial-gradient(circle at 40% 50%, rgba(143,93,66,0.32) 0 3px, transparent 4px),
        radial-gradient(circle at 56% 50%, rgba(143,93,66,0.32) 0 3px, transparent 4px),
        radial-gradient(circle at 72% 50%, rgba(143,93,66,0.32) 0 3px, transparent 4px),
        radial-gradient(circle at 88% 50%, rgba(143,93,66,0.32) 0 3px, transparent 4px);
      filter: blur(0.2px);
    }

    .marquee-dots::before { left: 14px; }
    .marquee-dots::after  { right: 14px; }

    /* ========================================================= */
    /* ========================= PANEL ========================= */
    /* ========================================================= */
.panel {
  width: 92%;
  margin-top: 14px;
  border-radius: var(--radius-panel);
  border: var(--stroke-w) solid var(--stroke);
  background: rgba(255,255,255,0.92);
  padding: 12px;
  padding-bottom: 16px;
  box-shadow: var(--shadow-1);
  position: relative;
  margin-bottom: var(--deck-gap);
}

    .panel::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 22px;
      border: var(--stroke-w2) solid var(--stroke-soft);
      pointer-events: none;
    }

    /* ========================================================= */
    /* ========================= SCREEN ======================== */
    /* ========================================================= */
    .screen {
      width: 100%;
      height: var(--screen-h);
      border-radius: var(--radius-screen);
      position: relative;
      overflow: hidden;
      background:
        radial-gradient(circle at 16% 18%, rgba(200, 235, 255, 0.50) 0%, rgba(255, 255, 255, 0.00) 58%),
        radial-gradient(circle at 84% 78%, rgba(255, 210, 232, 0.50) 0%, rgba(255, 255, 255, 0.00) 60%),
        linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(255,255,255,1) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .screen::before {
      content: "";
      position: absolute;
      inset: 8px;
      border-radius: 14px;
      border: 2px solid rgba(143,93,66,0.16);
      pointer-events: none;
    }

    /* Layout wrapper ensures claim always visible */
    .screen-flow {
      width: 100%;
      height: 100%;
      padding: 0 18px;
      padding-bottom: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    /* ========================================================= */
    /* =========================== HUD ========================= */
    /* ========================================================= */
    .hud {
      width: 100%;
      position: absolute;
      top: calc(12px + var(--safe-top));
      left: 0;
      right: 0;
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      pointer-events: none;
      z-index: 8;
    }

    .hud-left {
      display: flex;
      gap: 7px;
      align-items: center;
      pointer-events: none;
      user-select: none;
    }

    .life-heart {
      width: 20px;
      height: 20px;
      opacity: 0.95;
    }

    .life-heart svg {
      width: 100%;
      height: 100%;
      fill: var(--stroke);
      stroke: none;
    }

    .hud-right {
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .music-toggle {
      width: 22px;
      height: 22px;
      display: grid;
      place-items: center;
      cursor: pointer;
      pointer-events: auto;
      opacity: 1;
      transition: opacity 160ms ease;
      user-select: none;
    }

    .music-toggle.off {
      opacity: 0.35;
    }

    .music-toggle svg {
      width: 25px;
      height: 25px;
      stroke: var(--stroke);
      fill: none;
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .music-slash{
      opacity: 0;
      stroke: var(--stroke);
      stroke-width: 2.6;
      stroke-linecap: round;
      stroke-linejoin: round;
  }

.music-toggle.off .music-slash{
  opacity: 1;
}

    /* ========================================================= */
    /* ======================== TITLE AREA ===================== */
    /* ========================================================= */
    .title {
      width: 100%;
      margin-top: 58px;
      text-align: center;
      color: var(--ink);
      user-select: none;
    }

    .title h1 {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.2px;
      line-height: 1.06;
    }

    .title p {
      margin-top: 10px;
      font-size: 13px;
      font-weight: 400;
      opacity: 0.66;
      letter-spacing: 0.35px;
    }

    /* ========================================================= */
    /* ======================== CENTER WRAP ==================== */
    /* ========================================================= */
    .center-wrap {
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center; /* centers the 6 gifts vertically */
      align-items: center;
      padding-top: 10px;
      padding-bottom: 10px;
    }

    /* ========================================================= */
    /* ======================== GIFT GRID ====================== */
    /* ========================================================= */
    .gift-grid {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(3, 72px);
justify-content: center;
      gap: 14px;
      align-items: center;
      justify-items: center;
      transition: opacity 180ms ease, transform 180ms ease;
    }

    /* Make gifts slightly smaller and naturally centered */
    .gift-btn {
      width: 72px; /* smaller per feedback */
      height: 72px; /* smaller per feedback */
      border-radius: 999px;
      position: relative;
      cursor: pointer;
      user-select: none;

      background: rgba(255,255,255,0.86);
      border: var(--stroke-w) solid rgba(143,93,66,0.20);

      display: grid;
      place-items: center;

      transition:
        transform 120ms ease,
        box-shadow 160ms ease;
    }

    .gift-btn:active {
      transform: scale(0.95);
    }

    .gift-btn .ring {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border: var(--stroke-w) solid var(--stroke);
      pointer-events: none;
    }

    .gift-btn .dash {
      position: absolute;
      inset: 9px;
      border-radius: inherit;
      border: 2px dashed rgba(154,106,74,0.34);
      pointer-events: none;
    }

    .gift-btn .soft-glow {
      position: absolute;
      inset: -14px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 60%, rgba(255, 200, 220, 0.60) 0%, rgba(255, 200, 220, 0.00) 70%);
      opacity: 0;
      filter: blur(2px);
      pointer-events: none;
      transition: opacity 180ms ease;
    }

    .gift-btn.selected {
      box-shadow: 0 0 0 6px rgba(255, 215, 232, 0.72);
    }

    .gift-btn.selected .soft-glow {
      opacity: 1;
    }

    .gift-icon {
      width: 30px;
      height: 30px;
      position: relative;
      z-index: 2;
      display: grid;
      place-items: center;
    }

    .gift-icon svg {
      width: 28px;
      height: 28px;
      stroke: var(--stroke);
      fill: none;
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
  
    .gift-btn.is-sparkle .gift-icon{
  transform: scale(1.28);
}

    .gift-btn.is-sparkle .gift-icon svg{
      width: 30px;
      height: 35px;
  }

    .fill-blue { fill: var(--baby-blue-3); stroke: transparent; }
    .fill-pink { fill: var(--baby-pink-3); stroke: transparent; }

    /* Hide grid while modal open so it doesn't distract */
    .gift-grid.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0.985);
    }

    /* ========================================================= */
    /* ==================== SELECTED + CLAIM =================== */
    /* ========================================================= */
    .footer-actions {
      width: 100%;
      padding-top: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      z-index: 3;
    }

    .selected-pill {
      width: calc(100% - 38px);
      padding: 9px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      border: 2px solid rgba(154,106,74,0.20);
      font-size: 11px;
      color: var(--ink);
      letter-spacing: 0.35px;
      text-align: center;
      user-select: none;
      display: none;
    }

    .claim-btn{
  line-height: 1;
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  width: 56%;
  padding: 9px 14px;
      border-radius: 999px;
      border: var(--stroke-w) solid var(--stroke);
      background: rgba(255,255,255,0.94);
      color: var(--ink);
      font-size: 12.5px;
      font-weight: 800;
      letter-spacing: 0.35px;
      user-select: none;

      opacity: 0.45;
      cursor: not-allowed;

      transition:
        opacity 160ms ease,
        transform 120ms ease;
    }

    .claim-btn.active {
      opacity: 1;
      cursor: pointer;
    }

    .claim-btn.active:active {
      transform: scale(0.98);
    }

    /* ========================================================= */
    /* ====================== PARTICLES LAYER ================== */
    /* ========================================================= */
    .particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index:11;
    }

    .particle {
      position: absolute;
      top: -28px;
      left: 0;
      width: 18px;
      height: 18px;
      opacity: 0.0;
      will-change: transform, opacity;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.06));
      animation-name: fall;
      animation-timing-function: linear;
      animation-iteration-count: 1;
    }

    .particle svg {
      width: 100%;
      height: 100%;
      stroke: rgba(143,93,66,0.35);
      fill: none;
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .particle.pink svg { fill: rgba(255,205,226,0.90); stroke: rgba(255,205,226,0.0); }
    .particle.blue svg { fill: rgba(190,225,255,0.90); stroke: rgba(190,225,255,0.0); }

    @keyframes fall {
      0%   { opacity: 0; transform: translate(var(--x, 0px), -20px) rotate(var(--r0, 0deg)); }
      8%   { opacity: 0.95; }
      100% { opacity: 0; transform: translate(var(--x2, 0px), calc(var(--h, 420px) + 40px)) rotate(var(--r1, 140deg)); }
    }

    /* ========================================================= */
    /* ========================= TICKET ======================== */
    /* ========================================================= */
    .ticket {
      position: absolute;
      left: 70px;
      bottom: 90px;
      width: 100px;
      height: 160px;
      pointer-events: none;
      transform-origin: 22% 82%;
      transform: translateY(150px) rotate(-12deg);
      opacity: 0;
      z-index: 4;
    }

    /* IMPORTANT: ticket is NOT transparent */
    .ticket-card {
      width: 148px;
      height: 198px;
      border-radius: 18px;
      background:
        linear-gradient(
          180deg,
          rgba(255, 227, 242, 1.00) 0%,
          rgba(210, 238, 255, 1.00) 100%
        );
      border: var(--stroke-w) solid rgba(154,106,74,0.44);
      box-shadow: 0 16px 26px rgba(0,0,0,0.12);
      position: relative;
      overflow: hidden;
    }

    .ticket-card::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 14px;
      border: 2px dashed rgba(255,255,255,0.86);
      opacity: 0.96;
    }

    .ticket-card::after {
      content: "";
      position: absolute;
      top: -26px;
      left: -30px;
      width: 140px;
      height: 140px;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.65), rgba(255,255,255,0));
      opacity: 0.62;
      transform: rotate(18deg);
    }

    .ticket-text {
      position: relative;
      z-index: 1;
      padding: 22px 16px;
      text-align: center;
      color: rgba(143,93,66,0.92);
      letter-spacing: 0.6px;
      font-size: 14px;
      line-height: 1.35;
      user-select: none;
      font-weight: 700;
      text-transform: lowercase;
    }

    .ticket.show {
      animation: ticketOut 900ms cubic-bezier(.20,.90,.20,1) forwards;
    }

    @keyframes ticketOut {
      0%   { opacity: 0; transform: translateY(150px) rotate(-12deg); }
      55%  { opacity: 1; transform: translateY(18px) rotate(-16deg); }
      100% { opacity: 1; transform: translateY(0px) rotate(-16deg); }
    }

    /* Hide ticket cleanly after opening */
    .ticket.hide {
      animation: ticketHide 260ms ease forwards;
    }

    @keyframes ticketHide {
      0%   { opacity: 1; transform: translateY(0px) rotate(-16deg); }
      100% { opacity: 0; transform: translateY(12px) rotate(-18deg); }
    }

    /* ========================================================= */
    /* ========================= MODAL ========================= */
    /* ========================================================= */
    .modal {
      position: absolute;
      inset: 0;
      border-radius: 18px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9;
    }

    .modal.open {
      display: flex;
    }

    .modal-header {
      padding: 12px 14px 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 2px solid rgba(154,106,74,0.14);
      background: rgba(255,255,255,0.86);
      position: relative;
      z-index: 2;
    }

    .modal-title {
      font-size: 13px;
      font-weight: 800;
      letter-spacing: 0.35px;
      color: var(--ink);
      user-select: none;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
      text-transform: lowercase;
    }

    .modal-close {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: var(--stroke-w) solid var(--stroke);
      background: rgba(255,255,255,0.92);
      display: grid;
      place-items: center;
      cursor: pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,0.10);
      user-select: none;
    }

    .modal-close:active {
      transform: scale(0.96);
    }

    .modal-close svg {
      width: 18px;
      height: 18px;
      stroke: var(--stroke);
      stroke-width: 2.5;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 14px 16px 18px 16px;
      color: var(--ink);
      font-size: 13.5px;
      line-height: 1.7;
    }

    /* ========================================================= */
    /* ========================= PHOTO FRAME =================== */
    /* ========================================================= */
    .photo-frame {
      width: 100%;
      border-radius: 22px;
      border: var(--stroke-w) solid var(--stroke);
      background:
        radial-gradient(circle at 22% 20%, rgba(255,255,255,0.80) 0%, rgba(255,255,255,0.00) 58%),
        linear-gradient(180deg, rgba(210,238,255,0.86), rgba(255,230,242,0.86));
      padding: 10px;
      margin-bottom: 14px;
      position: relative;
      overflow: hidden;
    }

    .photo-frame::before {
      content: "";
      position: absolute;
      inset: 10px;
      border-radius: 16px;
      border: 2px dashed rgba(255,255,255,0.86);
      opacity: 0.92;
      pointer-events: none;
    }

    .photo-frame img {
      width: 100%;
      border-radius: 14px;
      position: relative;
      z-index: 1;
    }

    .frame-corners {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.85;
      z-index: 2;
    }

    .frame-corners svg {
      position: absolute;
      width: 22px;
      height: 22px;
      stroke: rgba(143,93,66,0.52);
      fill: none;
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .corner-tl { top: 8px; left: 8px; }
    .corner-tr { top: 8px; right: 8px; transform: scaleX(-1); }
    .corner-bl { bottom: 8px; left: 8px; transform: scaleY(-1); }
    .corner-br { bottom: 8px; right: 8px; transform: scale(-1); }

    /* ========================================================= */
    /* ======================= CONTENT TYPO ==================== */
    /* ========================================================= */
    .gift-heading {
      font-weight: 800;
      letter-spacing: 0.25px;
      margin: 2px 0 10px 0;
      opacity: 0.92;
      text-transform: lowercase;
    }

    .list {
      padding-left: 18px;
      opacity: 0.92;
    }

    .list li { margin-bottom: 6px; }

    .pill-note {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.86);
      border: 2px solid rgba(154,106,74,0.18);
      box-shadow: 0 10px 18px rgba(0,0,0,0.06);
    }

    /* ========================================================= */
    /* ======================= PLAYLIST BTN ==================== */
    /* ========================================================= */
    .playlist-btn {
      width: 100%;
      margin-top: 10px;
      padding: 14px 16px;
      border-radius: 999px;
      border: var(--stroke-w) solid var(--stroke);
      background: rgba(255,255,255,0.92);
      color: var(--ink);
      font-weight: 800;
      letter-spacing: 0.35px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 14px 22px rgba(0,0,0,0.08);
      text-transform: lowercase;
    }

    .playlist-btn:active {
      transform: scale(0.99);
    }

    /* ========================================================= */
    /* ==================== BACK DECOR BUTTON ================== */
    /* ========================================================= */
    .back-decor {
      position: absolute;
      right: 14px;
      bottom: 16px;
      width: 48px;
      height: 48px;
      border-radius: 999px;
      border: var(--stroke-w) solid var(--stroke);
      background: rgba(255,255,255,0.94);
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 12px 20px rgba(0,0,0,0.10);
      z-index: 12; /* above modal body so never clipped */
    }

    .back-decor.show { display: flex; }

    .back-decor:active { transform: scale(0.96); }

   .back-decor svg {
      width: 22px;
      height: 22px;
      stroke: var(--stroke);
      fill: none;
      stroke-width: 2.6;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

/* TARUH DI SINI */
@supports (-webkit-touch-callout: none) {
  .back-decor{
    bottom: 20px;
  }
}

    /* ========================================================= */
    /* ========================= DECK ========================== */
    /* ========================================================= */
    .deck {
      width: 92%;
      margin-top: auto;
      padding: 12px 12px calc(18px + var(--safe-bottom)) 12px;
      position: relative;
      flex: 0 0 auto;
  }

    .deck::before {
      content: "";
      position: absolute;
      top: 0;
      left: -2px;
      right: -2px;
      height: 2px;
      border-radius: 999px;
      background: rgba(154,106,74,0.24);
      opacity: 0.95;
    }

    .controls {
     width: 100%;
      height: 148px;
      position: relative;
  }

/* TARUH DI LUAR (bukan di dalam .controls) */
    @supports (-webkit-touch-callout: none) {
      .controls { height: 160px; }
  }
  

    /* joystick (decorative) */
    .joystick {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 38px;
      width: 92px;
      height: 92px;
      display: grid;
      place-items: center;
      opacity: 0.98;
    }

    .joy-plate {
      position: absolute;
      bottom: 0.5px;
      width: 92px;
      height: 42px;
      border-radius: 22px;
      background: rgba(0,0,0,0.10);
      opacity: 0.33;
    }

    .joy-stick {
      position: absolute;
      top: 30px;
      left: 38.5px;
      width: 10px;
      height: 52px;
      border-radius: 999px;
      background: rgba(143,93,66,0.96);
    }

    .joy-ball {
      position: absolute;
      top: 0px;
      left: 20px;
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: var(--stroke-w) solid var(--stroke);
      background: rgba(255, 205, 226, 0.96);
      box-shadow: 0 10px 18px rgba(0,0,0,0.10);
    }

/* pill buttons (decorative) */
.btns{
  position: absolute;
  left: 50%;
  right: auto;
  transform: translateX(-50%);
  bottom: 50px;
  display: flex;
  gap: 20px;
  justify-content: center;
  align-items: center;
}

    .btn-pill {
      width: 84px;
      height: 32px;
      border-radius: 999px;
      border: var(--stroke-w) solid var(--stroke);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,0.58);
    }

    .btn-pill.blue { background: rgba(190,225,255,0.95); }
    .btn-pill.pink { background: rgba(255,205,226,0.95); }
.btn-pill.blue{ margin-right: 18px; }
.btn-pill.pink{ margin-left: 18px; } 

/* biar button ga nimpa joystick */
.btns{
  left: 50%;
}

@supports (-webkit-touch-callout: none) {
  :root{
    --deck-gap: 28px; /* iPhone butuh gap lebih */
  }
}

    /* ticket slot */
    .slot {
      position: absolute;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      width: 150px;
      height: 18px;
      border-radius: 999px;
      background: rgba(0,0,0,0.28);
    }

    /* ========================================================= */
    /* =================== ACCESSIBILITY FOCUS ================= */
    /* ========================================================= */
    .focusable:focus {
      outline: 3px solid rgba(190,225,255,0.85);
      outline-offset: 3px;
      border-radius: 14px;
    }

    /* ========================================================= */
    /* ======================= RESPONSIVE ====================== */
    /* ========================================================= */
    @media (max-height: 740px) {
      :root {
        --cab-h: 700px;
        --screen-h: 392px;
        --deck-gap: 18px; /* jarak kosong antara panel dan deck */
      }

      .title h1 { font-size: 25px; }
      .gift-btn { width: 70px; height: 70px; }
      .gift-grid { gap: 13px; }
    }

    @media (max-width: 360px) {
      .gift-btn { width: 68px; height: 68px; }
      .gift-icon svg { width: 26px; height: 26px; }
      .claim-btn { width: 66%; }
      .selected-pill { width: calc(100% - 34px); }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="cabinet" id="cabinet">
      <!-- ===================================================== -->
      <!-- ======================= MARQUEE ====================== -->
      <!-- ===================================================== -->
      <div class="top-cap">
        <div class="marquee-dots"></div>
        <div class="marquee-text">arcade love story</div>
      </div>

      <!-- ===================================================== -->
      <!-- ======================== PANEL ======================= -->
      <!-- ===================================================== -->
      <div class="panel">
        <div class="screen" id="screen">
          <!-- =================================================== -->
          <!-- ========================= HUD ====================== -->
          <!-- =================================================== -->
          <div class="hud">
            <div class="hud-left" aria-hidden="true">
              <div class="life-heart">
                <svg viewBox="0 0 24 24">
                  <path d="M12 21s-8-4.7-8-10.1C4 7.5 6.5 5.7 9 6.1c1.3.2 2.4 1 3 2c.6-1 1.7-1.8 3-2c2.5-.4 5 1.4 5 4.8C20 16.3 12 21 12 21z"></path>
                </svg>
              </div>
              <div class="life-heart">
                <svg viewBox="0 0 24 24">
                  <path d="M12 21s-8-4.7-8-10.1C4 7.5 6.5 5.7 9 6.1c1.3.2 2.4 1 3 2c.6-1 1.7-1.8 3-2c2.5-.4 5 1.4 5 4.8C20 16.3 12 21 12 21z"></path>
                </svg>
              </div>
              <div class="life-heart">
                <svg viewBox="0 0 24 24">
                  <path d="M12 21s-8-4.7-8-10.1C4 7.5 6.5 5.7 9 6.1c1.3.2 2.4 1 3 2c.6-1 1.7-1.8 3-2c2.5-.4 5 1.4 5 4.8C20 16.3 12 21 12 21z"></path>
                </svg>
              </div>
            </div>

            <div class="hud-right">
              <div
                class="music-toggle focusable"
                id="musicToggle"
                role="button"
                tabindex="0"
                aria-label="toggle music"
              >
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M10 18a2.2 2.2 0 1 1 0-4.4"></path>
                  <path d="M10 16.2V6.2l10-2v11"></path>
                  <path d="M20 14a2.2 2.2 0 1 1 0-4.4"></path>
                  <path class="music-slash" d="M4 4L20 20"></path>
                </svg>
              </div>
            </div>
          </div>

          <!-- =================================================== -->
          <!-- ====================== FLOW ======================== -->
          <!-- =================================================== -->
          <div class="screen-flow">
            <!-- TITLE -->
            <div class="title">
              <h1>choose your gift</h1>
              <p>tap one gift, then claim your ticket</p>
            </div>

            <!-- CENTER (6 GIFTS) -->
            <div class="center-wrap">
              <div class="gift-grid" id="giftGrid" aria-label="gift selection">
                <!-- GIFT 1: HEART -->
                <div class="gift-btn focusable" data-gift="heart" role="button" tabindex="0" aria-label="gift heart">
                  <div class="soft-glow"></div>
                  <div class="ring"></div>
                  <div class="dash"></div>
                  <div class="gift-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path d="M12 21s-8-4.7-8-10.1C4 7.5 6.5 5.7 9 6.1c1.3.2 2.4 1 3 2c.6-1 1.7-1.8 3-2c2.5-.4 5 1.4 5 4.8C20 16.3 12 21 12 21z"></path>
                    </svg>
                  </div>
                </div>

                <!-- GIFT 2: RIBBON -->
                <div class="gift-btn focusable" data-gift="ribbon" role="button" tabindex="0" aria-label="gift ribbon">
                  <div class="soft-glow"></div>
                  <div class="ring"></div>
                  <div class="dash"></div>
                  <div class="gift-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path class="fill-pink" d="M8.1 12.1c-1.7 0-3-1.3-3-3s1.3-3 3-3c1.1 0 2 .5 2.5 1.3"></path>
                      <path class="fill-pink" d="M15.9 12.1c1.7 0 3-1.3 3-3s-1.3-3-3-3c-1.1 0-2 .5-2.5 1.3"></path>
                      <path d="M10.5 8.2c.5 1 1.1 1.7 1.5 1.9c.4-.2 1-.9 1.5-1.9"></path>
                      <path d="M11.2 10.2l-3.8 7.1"></path>
                      <path d="M12.8 10.2l3.8 7.1"></path>
                    </svg>
                  </div>
                </div>

                <!-- GIFT 3: STAR -->
                <div class="gift-btn focusable" data-gift="star" role="button" tabindex="0" aria-label="gift star">
                  <div class="soft-glow"></div>
                  <div class="ring"></div>
                  <div class="dash"></div>
                  <div class="gift-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path class="fill-blue" d="M12 3.2l2.3 5.2l5.6.5l-4.2 3.5l1.3 5.4L12 15.9L7 17.8l1.3-5.4L4.1 8.9l5.6-.5L12 3.2z"></path>
                    </svg>
                  </div>
                </div>

                <!-- GIFT 4: SPARKLE -->
                <div class="gift-btn focusable is-sparkle" data-gift="sparkle" role="button" tabindex="0" aria-label="gift sparkle">
                  <div class="soft-glow"></div>
                  <div class="ring"></div>
                  <div class="dash"></div>
                  <div class="gift-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path class="fill-blue" d="M12 3.2l1.5 4.6l4.6 1.5l-4.6 1.5L12 15.4l-1.5-4.6L5.9 9.3l4.6-1.5L12 3.2z"></path>
                    </svg>
                  </div>
                </div>

                <!-- GIFT 5: ICE CREAM -->
                <div class="gift-btn focusable" data-gift="icecream" role="button" tabindex="0" aria-label="gift icecream">
                  <div class="soft-glow"></div>
                  <div class="ring"></div>
                  <div class="dash"></div>
                  <div class="gift-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path d="M7.8 10.2h8.4"></path>
                      <path class="fill-pink" d="M12 4.2c2.8 0 5 2.1 5 4.8v1.2H7V9c0-2.7 2.2-4.8 5-4.8z"></path>
                      <path d="M8 10.2l4 9.6l4-9.6"></path>
                    </svg>
                  </div>
                </div>

                <!-- GIFT 6: BUTTERFLY -->
                <div class="gift-btn focusable" data-gift="butterfly" role="button" tabindex="0" aria-label="gift butterfly">
                  <div class="soft-glow"></div>
                  <div class="ring"></div>
                  <div class="dash"></div>
                  <div class="gift-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24">
                      <path class="fill-pink" d="M12 12c-1.8-3.2-5.2-4.8-7.3-3.5c-2.2 1.4-.7 5.7 3 7.6"></path>
                      <path class="fill-pink" d="M12 12c1.8-3.2 5.2-4.8 7.3-3.5c2.2 1.4.7 5.7-3 7.6"></path>
                      <path d="M12 12v6"></path>
                      <path d="M11 18h2"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <!-- SELECTED + CLAIM (always visible) -->
            <div class="footer-actions">
              <div class="selected-pill" id="selectedPill">selected: —</div>
              <button class="claim-btn" id="claimBtn" type="button">claim your ticket</button>
            </div>
          </div>

          <!-- PARTICLES -->
          <div class="particles" id="particles" aria-hidden="true"></div>

          <!-- TICKET -->
          <div class="ticket" id="ticket" aria-hidden="true">
            <div class="ticket-card">
              <div class="ticket-text" id="ticketText">
                character:<br>
                <span style="font-weight:800">—</span><br>
                open your<br>
                gift
              </div>
            </div>
          </div>

          <!-- MODAL -->
          <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="gift content">
            <div class="modal-header">
              <div class="modal-title" id="modalTitle">your gift</div>
              <div class="modal-close focusable" id="modalClose" role="button" tabindex="0" aria-label="close">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M7 7l10 10"></path>
                  <path d="M17 7L7 17"></path>
                </svg>
              </div>
            </div>
            <div class="modal-body" id="modalBody"></div>
          </div>

          <!-- BACK (must never be clipped) -->
          <div class="back-decor focusable" id="backDecor" role="button" tabindex="0" aria-label="back">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M14.5 6.5L8.5 12l6 5.5"></path>
            </svg>
          </div>

        </div>
      </div>

      <!-- ===================================================== -->
      <!-- ===================== CONTROL DECK =================== -->
      <!-- ===================================================== -->
      <div class="deck">
        <div class="controls" aria-hidden="true">
          <div class="joystick">
            <div class="joy-plate"></div>
            <div class="joy-stick"></div>
            <div class="joy-ball"></div>
          </div>

          <div class="btns">
            <div class="btn-pill blue"></div>
            <div class="btn-pill pink"></div>
          </div>

          <div class="slot"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- REQUIRED AUDIO -->
  <audio id="bgm" src="anartgallery.mp3" loop preload="auto"></audio>

  <!-- ========================================================= -->
  <!-- ======================== SVG LIB ======================= -->
  <!-- ========================================================= -->
  <svg width="0" height="0" style="position:absolute; left:-9999px; top:-9999px;" aria-hidden="true" focusable="false">
    <defs>
      <symbol id="p-heart" viewBox="0 0 24 24">
        <path d="M12 21s-8-4.7-8-10.1C4 7.5 6.5 5.7 9 6.1c1.3.2 2.4 1 3 2c.6-1 1.7-1.8 3-2c2.5-.4 5 1.4 5 4.8C20 16.3 12 21 12 21z"></path>
      </symbol>

      <symbol id="p-star" viewBox="0 0 24 24">
        <path d="M12 3.2l2.3 5.2l5.6.5l-4.2 3.5l1.3 5.4L12 15.9L7 17.8l1.3-5.4L4.1 8.9l5.6-.5L12 3.2z"></path>
      </symbol>

      <symbol id="p-sparkle" viewBox="0 0 24 24">
        <path d="M12 3.2l1.5 4.6l4.6 1.5l-4.6 1.5L12 15.4l-1.5-4.6L5.9 9.3l4.6-1.5L12 3.2z"></path>
      </symbol>

      <symbol id="p-bow" viewBox="0 0 24 24">
        <path d="M8.1 12.1c-1.7 0-3-1.3-3-3s1.3-3 3-3c1.1 0 2 .5 2.5 1.3"></path>
        <path d="M15.9 12.1c1.7 0 3-1.3 3-3s-1.3-3-3-3c-1.1 0-2 .5-2.5 1.3"></path>
        <path d="M10.5 8.2c.5 1 1.1 1.7 1.5 1.9c.4-.2 1-.9 1.5-1.9"></path>
      </symbol>

      <symbol id="p-note" viewBox="0 0 24 24">
        <path d="M10 18a2.2 2.2 0 1 1 0-4.4"></path>
        <path d="M10 16.2V6.2l10-2v11"></path>
        <path d="M20 14a2.2 2.2 0 1 1 0-4.4"></path>
      </symbol>

      <symbol id="p-butterfly" viewBox="0 0 24 24">
        <path d="M12 12c-1.8-3.2-5.2-4.8-7.3-3.5c-2.2 1.4-.7 5.7 3 7.6"></path>
        <path d="M12 12c1.8-3.2 5.2-4.8 7.3-3.5c2.2 1.4.7 5.7-3 7.6"></path>
        <path d="M12 12v6"></path>
      </symbol>
    </defs>
  </svg>

  <script>
    /* ========================================================= */
    /* ======================= UTILITIES ======================= */
    /* ========================================================= */
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
    function rand(min, max) { return Math.random() * (max - min) + min; }
    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function onPress(el, fn) {
      el.addEventListener("pointerdown", (e) => {
    // ini bikin tap mana pun bisa nyalain music (kalau ON)
    if (typeof requestMusicStart === "function") requestMusicStart();

    e.preventDefault();
    fn(e);
      }, { passive: false });
  }

    function onKeyPress(el, fn) {
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          fn(e);
        }
      });
    }

    /* ========================================================= */
    /* ======================= DOM REFS ======================== */
    /* ========================================================= */
    const bgm = $("#bgm");
    const musicToggle = $("#musicToggle");

    const giftGrid = $("#giftGrid");
    const giftButtons = $$(".gift-btn");

    const selectedPill = $("#selectedPill");
    const claimBtn = $("#claimBtn");

    const ticket = $("#ticket");
    const ticketText = $("#ticketText");

    const particlesLayer = $("#particles");

    const modal = $("#modal");
    const modalTitle = $("#modalTitle");
    const modalBody = $("#modalBody");
    const modalClose = $("#modalClose");

    const backDecor = $("#backDecor");

    /* ========================================================= */
    /* ======================= STATE =========================== */
    /* ========================================================= */
    const state = {
      selectedGift: null,
      isMusicOn: true,
      ticketBusy: false,
      particleTimer: null,
      particleRunId: 0,
      playlistUrl: "https://open.spotify.com/playlist/0HCnLxHJt2gkN6py6fJRpY", // replace with your playlist link
      ticketAutoHideMsAfterOpen: 120,          // hide ticket quickly so it won't block taps
      
      resumeTime: 0,
resumeArmed: false,
    };

    /* ========================================================= */
    /* ======================= MUSIC =========================== */
    /* ========================================================= */
   function syncMusicUI() {
      musicToggle.classList.toggle("off", !state.isMusicOn);
    }
 
    function setMusic(on) {
      state.isMusicOn = on;
      syncMusicUI();

      if (on) {
      bgm.play().catch(() => {});
      } else {
      bgm.pause();
      }
  }

    function toggleMusic() {
      setMusic(!state.isMusicOn);
    }

    onPress(musicToggle, () => toggleMusic());
    onKeyPress(musicToggle, () => toggleMusic());

    bgm.addEventListener("play", () => {
      if (!state.isMusicOn) bgm.pause();
    });
  
    let musicGestureArmed = true;

      function requestMusicStart() {
      if (!musicGestureArmed) return;
      if (!state.isMusicOn) return;

      musicGestureArmed = false;
      bgm.play().catch(() => {
    // kalau gagal (browser), re-arm biar gesture berikutnya coba lagi
    musicGestureArmed = true;
      });
  }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") {
      // simpan posisi terakhir kalau musik lagi jalan
      if (!bgm.paused) {
      state.resumeTime = bgm.currentTime || 0;
      state.resumeArmed = true;
      bgm.pause();
      }
      return;
     }

  // balik ke tab
  if (state.isMusicOn && state.resumeArmed) {
    state.resumeArmed = false;
    try { bgm.currentTime = state.resumeTime || 0; } catch (_) {}
    bgm.play().catch(() => {});
  }
});

    state.isMusicOn = true;
    syncMusicUI();

    /* ========================================================= */
    /* ======================= GIFT DATA ======================= */
    /* ========================================================= */
    // Place your romantic photos next to this index.html:
    // lau1.jpg
    // lau2.jpg
    // lau3.jpg
    // (optional) photo-sparkle.jpg / photo-icecream.jpg / photo-butterfly.jpg

    const giftMeta = {
      heart: {
        label: "heart",
        title: "gift 1: heart",
        particles: { shape: "p-heart", density: 52 },
        contentHTML: `
          <div class="photo-frame">
            <div class="frame-corners" aria-hidden="true">
              <svg class="corner-tl" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-tr" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-bl" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-br" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
            </div>
            <img src="lau1.jpg" alt="romantic photo heart">
          </div>
          <div class="pill-note">
            <div class="gift-heading">for you</div>
            <p>
              i just want you to know how much you mean to me. being with you makes my days feel lighter and my heart feel safe. your care, your words, even the little things you do always stay with me longer than you know. thank you for loving me the way you do. i’m so grateful i get to call you mine.
            </p>
          </div>
        `,
      },

      ribbon: {
        label: "ribbon",
        title: "gift 2: ribbon",
        particles: { shape: "p-bow", density: 44 },
        contentHTML: `
          <div class="photo-frame">
            <div class="frame-corners" aria-hidden="true">
              <svg class="corner-tl" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-tr" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-bl" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-br" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
            </div>
            <img src="lau2.jpg" alt="romantic photo ribbon">
          </div>
          <div class="gift-heading">5 facts about him</div>
          <ul class="list">
            <li>he’s such a soft and gentle person.</li>
            <li>he pays attention to the tiniest little things.</li>
            <li>he gets adorably jealous sometimes.</li>
            <li>he’s super kind, even if he can be a bit grumpy now and then.</li>
            <li>he loves it when i tell him lots of stories.</li>
          </ul>
        `,
      },

      star: {
        label: "star",
        title: "gift 3: star",
        particles: { shape: "p-star", density: 46 },
        contentHTML: `
          <div class="photo-frame">
            <div class="frame-corners" aria-hidden="true">
              <svg class="corner-tl" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-tr" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-bl" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
              <svg class="corner-br" viewBox="0 0 24 24"><path d="M6 10V6h4"></path></svg>
            </div>
            <img src="lau3.jpg" alt="romantic photo star">
          </div>
          <div class="gift-heading">5 things i hate about him</div>
          <ul class="list">
            <li>he overthinks way too much.</li>
            <li>he doesn’t want to rest even when he’s already tired.</li>
            <li>when he’s sleepy, he still refuses to go to sleep.</li>
            <li>he sleeps for too long sometimes ( and i end up missing him:p ).</li>
            <li>he lies sometimes./li>
          </ul>
        `,
      },

      sparkle: {
        label: "sparkle",
        title: "gift 4: sparkle",
        particles: { shape: "p-sparkle", density: 54 },
        contentHTML: `
          <div class="gift-heading">10 things i huge love about him</div>
          <ol class="list">
            <li>the way he talks to me so gently.</li>
            <li>how he always tries to understand me.</li>
            <li>his cute jealous side.</li>
            <li>the way he cares about little details.</li>
            <li>how safe I feel when I’m with him.</li>
            <li>the way he remembers little things about me.</li>
            <li>the way he worries about me.</li>
            <li>his efforts </li>
            <li>how he stays, even when i’m not at my best.</li>
            <li>the way he makes me feel loved without even trying.</li>
          </ol>
        `,
      },

      icecream: {
        label: "icecream",
        title: "gift 5: icecream",
        particles: { shape: "p-note", density: 48 },
        contentHTML: `
          <div class="pill-note">
            <div class="gift-heading">sweet little note</div>
            <p>
              just a tiny reminder that you mean so much to me. you make my days warmer, my thoughts softer, and my heart feel safe in a way i never knew it could. i’m really grateful for you for your care, your presence, and all the little ways you show your love. i’m so lucky I get to call you mine
            </p>
          </div>
          <button class="playlist-btn" id="playlistBtn" type="button">
            take me to our playlist
          </button>
        `,
      },

      butterfly: {
        label: "butterfly",
        title: "gift 6: butterfly",
        particles: { shape: "p-butterfly", density: 40 },
        contentHTML: `
          <div class="gift-heading">love letter</div>
          <div class="pill-note">
            <p style="opacity:.95;margin-bottom:12px">
              my love, every day with you feels like a gentle reset.
              the world gets quieter in the best way when i think of you,
              and my heart feels less heavy because you exist.
            </p>
            <p style="opacity:.95">
              happy 4th monthsary, kakak. four months may not seem like a long time, but with you, every moment has felt meaningful and full of warmth. somewhere along the way, you became my favorite person, my comfort, my safe place, and the one i always want to share my day with, even the smallest, most random parts. thank you for being patient with me, especially with my overthinking and unpredictable moods. you never make me feel like i’m “too much.” instead, you stay, you listen, and you care in ways that make my heart feel calm and understood, and that means more to me than i can ever fully put into words. i love the quiet ways you show your love, the little check-ins, the concern in your words, the simple presence that makes everything feel lighter. being loved by you feels gentle, steady, and real. i don’t know exactly what the future holds, but i do know that i’m truly grateful to be loving you right now, in this chapter of my life. these four months are memories i’ll always hold close to my heart. 
            </p>
          </div>
        `,
      },
    };

    /* ========================================================= */
    /* ======================= SELECTION ======================= */
    /* ========================================================= */
    function setSelectedGift(giftKey) {
      state.selectedGift = giftKey;

      giftButtons.forEach(btn => {
        const isMe = btn.getAttribute("data-gift") === giftKey;
        btn.classList.toggle("selected", isMe);
      });

      selectedPill.style.display = "block";
      selectedPill.textContent = "selected: " + giftMeta[giftKey].label;

      claimBtn.classList.add("active");
      claimBtn.style.cursor = "pointer";

      ticketText.innerHTML =
        "character:<br>" +
        "<span style='font-weight:800'>" + giftMeta[giftKey].label + "</span><br>" +
        "open your<br>gift";
    }

    giftButtons.forEach(btn => {
      const key = btn.getAttribute("data-gift");
      onPress(btn, () => setSelectedGift(key));
      onKeyPress(btn, () => setSelectedGift(key));
    });

    /* ========================================================= */
    /* ======================= TICKET FLOW ===================== */
    /* ========================================================= */
    function showTicket() {
      ticket.classList.remove("hide");
      ticket.classList.remove("show");
      void ticket.offsetWidth;
      ticket.classList.add("show");
    }

    function hideTicketSoon() {
      // hide ticket so it never blocks gift selection afterwards
      setTimeout(() => {
        ticket.classList.remove("show");
        ticket.classList.add("hide");
      }, state.ticketAutoHideMsAfterOpen);
    }

    function runTicketThenOpen() {
      if (!state.selectedGift) return;
      if (state.ticketBusy) return;
      if (!claimBtn.classList.contains("active")) return;

      state.ticketBusy = true;

      showTicket();

      // Open after ticket reveal finishes (matches animation duration)
      setTimeout(() => {
        openGift(state.selectedGift);
        hideTicketSoon();
        state.ticketBusy = false;
      }, 900);
    }

    onPress(claimBtn, () => runTicketThenOpen());
    onKeyPress(claimBtn, () => runTicketThenOpen());

    /* ========================================================= */
    /* =================== OPEN / CLOSE GIFT =================== */
    /* ========================================================= */
    function openGift(giftKey) {
      const meta = giftMeta[giftKey];
      if (!meta) return;

      // Hide gift icons while open so they don't distract
      giftGrid.classList.add("hidden");

      modalTitle.textContent = meta.title;
      modalBody.innerHTML = meta.contentHTML;
      modal.classList.add("open");

      backDecor.classList.remove("show");

      // Playlist button wiring
      const playlistBtn = $("#playlistBtn", modalBody);
      if (playlistBtn) {
        const goPlaylist = () => {
  // simpan + pause dulu
  state.resumeTime = bgm.currentTime || 0;
  state.resumeArmed = true;
  bgm.pause();

  // pindah halaman (lebih stabil dari window.open untuk _self)
  window.location.assign(state.playlistUrl);
};

onPress(playlistBtn, goPlaylist);
onKeyPress(playlistBtn, goPlaylist);
      }

      // Particles per gift
      startParticlesForGift(giftKey);
    }

    function closeGift() {
      modal.classList.remove("open");
      backDecor.classList.remove("show");
      giftGrid.classList.remove("hidden");
      stopParticles();

      // Ensure ticket is gone
      ticket.classList.remove("show");
      ticket.classList.add("hide");
    }

    onPress(backDecor, () => closeGift());
    onKeyPress(backDecor, () => closeGift());

    onPress(modalClose, () => closeGift());
    onKeyPress(modalClose, () => closeGift());

    /* ========================================================= */
    /* ======================= PARTICLES ======================= */
    /* ========================================================= */
    function clearParticlesLayer() {
      particlesLayer.innerHTML = "";
    }

    function stopParticles() {
      state.particleRunId++;
      if (state.particleTimer) {
        clearInterval(state.particleTimer);
        state.particleTimer = null;
      }
      clearParticlesLayer();
    }

    function makeParticleNode(symbolId, variant) {
      const node = document.createElement("div");
      node.className = "particle " + variant;

      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("viewBox", "0 0 24 24");

      const use = document.createElementNS("http://www.w3.org/2000/svg", "use");
      use.setAttributeNS("http://www.w3.org/1999/xlink", "href", "#" + symbolId);

      svg.appendChild(use);
      node.appendChild(svg);

      return node;
    }

    function spawnParticle(symbolId, runId) {
      if (runId !== state.particleRunId) return;

      const layerRect = particlesLayer.getBoundingClientRect();
      const w = layerRect.width;
      const h = layerRect.height;

      const xStart = rand(10, w - 10);
      const drift = rand(-42, 42);
      const size = rand(14, 22);

      const dur = rand(3.6, 6.2);
      const delay = rand(0, 0.9);

      const r0 = rand(-30, 30);
      const r1 = r0 + rand(140, 260);

      const variant = pick(["pink", "blue"]);

      const el = makeParticleNode(symbolId, variant);
      el.style.width = size + "px";
      el.style.height = size + "px";

      el.style.setProperty("--x", xStart + "px");
      el.style.setProperty("--x2", (xStart + drift) + "px");
      el.style.setProperty("--h", h + "px");
      el.style.setProperty("--r0", r0 + "deg");
      el.style.setProperty("--r1", r1 + "deg");

      el.style.animationDuration = dur + "s";
      el.style.animationDelay = delay + "s";

      particlesLayer.appendChild(el);

      const totalMs = (dur + delay) * 1000 + 80;
      setTimeout(() => {
        if (el && el.parentNode) el.parentNode.removeChild(el);
      }, totalMs);
    }

    function startParticlesForGift(giftKey) {
      stopParticles();

      const meta = giftMeta[giftKey];
      if (!meta || !meta.particles) return;

      const runId = ++state.particleRunId;
      const symbolId = meta.particles.shape;
      const density = clamp(meta.particles.density || 40, 24, 76);

      // Initial fill: lots of particles like "soft snow"
      for (let i = 0; i < density; i++) {
        spawnParticle(symbolId, runId);
      }

      // Continuous gentle spawn
      state.particleTimer = setInterval(() => {
        const count = Math.round(clamp(density / 12, 2, 6));
        for (let i = 0; i < count; i++) {
          spawnParticle(symbolId, runId);
        }
      }, 520);
    }
  
  </script>
</body>
</html>
